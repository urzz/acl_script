name: æ›´æ–° Fake IP è¿‡æ»¤è§„åˆ™

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 2:00 æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'rules/mihomo/fake_ip_filter.list'
      - '.github/workflows/update-fake-ip-filter.yml'

jobs:
  update-fake-ip-filter:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: ä¸‹è½½å’Œå¤„ç† Fake IP è¿‡æ»¤è§„åˆ™
      run: |
        python3 << 'EOF'
        import urllib.request
        import os
        import sys
        
        def read_remote_file(url):
            """å®‰å…¨åœ°è¯»å–è¿œç¨‹æ–‡ä»¶ï¼Œå¿½ç•¥é”™è¯¯"""
            try:
                with urllib.request.urlopen(url, timeout=30) as response:
                    content = response.read().decode('utf-8').splitlines()
                    print(f"âœ… æˆåŠŸè¯»å–è¿œç¨‹æ–‡ä»¶ï¼Œå…± {len(content)} è¡Œ")
                    return content
            except Exception as e:
                print(f"âŒ æ— æ³•è¯»å–è¿œç¨‹æ–‡ä»¶ {url}: {e}")
                return []
        
        def read_local_file(filepath):
            """å®‰å…¨åœ°è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œå¿½ç•¥é”™è¯¯"""
            try:
                if os.path.exists(filepath):
                    with open(filepath, 'r', encoding='utf-8') as f:
                        content = f.read().splitlines()
                        print(f"âœ… æœ¬åœ°æ–‡ä»¶å­˜åœ¨ï¼Œå…± {len(content)} è¡Œ")
                        return content
                else:
                    print(f"âš ï¸  æœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨: {filepath}")
                    return []
            except Exception as e:
                print(f"âŒ æ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶ {filepath}: {e}")
                return []
        
        def needs_quotes(domain):
            """åˆ¤æ–­åŸŸåæ˜¯å¦éœ€è¦ç”¨å¼•å·åŒ…èµ·æ¥"""
            # åŒ…å«é€šé…ç¬¦æˆ–ç‰¹æ®Šå­—ç¬¦çš„éœ€è¦åŠ å¼•å·
            special_chars = ['*', '+']
            return any(char in domain for char in special_chars) or domain.startswith('.')
        
        def filter_lines(lines):
            """è¿‡æ»¤æ‰æ³¨é‡Šè¡Œå’Œç©ºè¡Œï¼Œä¿æŒåŸå§‹åŸŸåæ ¼å¼ï¼Œé€‚å½“æ·»åŠ å¼•å·"""
            filtered = []
            skipped_count = 0
            
            for line in lines:
                original_line = line
                line = line.strip()
                
                # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
                if not line or line.startswith('#'):
                    skipped_count += 1
                    continue
                    
                # ç§»é™¤è¡Œå†…æ³¨é‡Š
                if '#' in line:
                    line = line.split('#')[0].strip()
                    if not line:
                        skipped_count += 1
                        continue
                
                # æ ¹æ®æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦å†³å®šæ˜¯å¦åŠ å¼•å·
                if needs_quotes(line):
                    filtered.append(f"  - '{line}'")
                else:
                    filtered.append(f"  - {line}")
            
            print(f"ğŸ“Š è¿‡æ»¤ç»Ÿè®¡: è·³è¿‡ {skipped_count} è¡Œæ³¨é‡Š/ç©ºè¡Œï¼Œä¿ç•™ {len(filtered)} è¡Œæœ‰æ•ˆè§„åˆ™")
            return filtered
        
        # è¿œç¨‹æ–‡ä»¶ URL
        remote_url = "https://raw.githubusercontent.com/juewuy/ShellCrash/refs/heads/dev/public/fake_ip_filter.list"
        
        # æœ¬åœ°æ–‡ä»¶è·¯å¾„
        local_file = "rules/mihomo/fake_ip_filter.list"
        
        # è¾“å‡ºæ–‡ä»¶è·¯å¾„
        output_file = "rules/mihomo/fake_ip_filter.yaml"
        
        print("ğŸš€ å¼€å§‹å¤„ç† Fake IP è¿‡æ»¤è§„åˆ™...")
        print(f"ğŸ“¥ è¿œç¨‹æ–‡ä»¶: {remote_url}")
        print(f"ğŸ“„ æœ¬åœ°æ–‡ä»¶: {local_file}")
        print(f"ğŸ“¤ è¾“å‡ºæ–‡ä»¶: {output_file}")
        
        # è¯»å–è¿œç¨‹æ–‡ä»¶
        print("\nğŸ“¡ è¯»å–è¿œç¨‹æ–‡ä»¶...")
        remote_lines = read_remote_file(remote_url)
        
        # è¯»å–æœ¬åœ°æ–‡ä»¶
        print("\nğŸ“ è¯»å–æœ¬åœ°æ–‡ä»¶...")
        local_lines = read_local_file(local_file)
        
        # åˆå¹¶æ‰€æœ‰è¡Œ
        all_lines = remote_lines + local_lines
        print(f"\nğŸ“‹ åˆå¹¶åå…± {len(all_lines)} è¡ŒåŸå§‹æ•°æ®")
        
        if len(all_lines) == 0:
            print("âŒ æ²¡æœ‰è¯»å–åˆ°ä»»ä½•è§„åˆ™æ•°æ®ï¼")
            sys.exit(1)
        
        # æ˜¾ç¤ºå‰å‡ è¡ŒåŸå§‹å†…å®¹
        print("\nğŸ“ åŸå§‹å†…å®¹ç¤ºä¾‹ï¼ˆå‰10è¡Œï¼‰:")
        for i, line in enumerate(all_lines[:10]):
            print(f"   {i+1:2d}. {repr(line)}")
        
        # è¿‡æ»¤å¤„ç†
        print("\nğŸ” è¿‡æ»¤å’Œå¤„ç†è§„åˆ™...")
        filtered_rules = filter_lines(all_lines)
        
        # å»é‡ä½†ä¿æŒåŸå§‹æ ¼å¼
        unique_rules = list(dict.fromkeys(filtered_rules))
        print(f"ğŸ¯ å»é‡åå…± {len(unique_rules)} æ¡å”¯ä¸€è§„åˆ™")
        
        # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
        os.makedirs(os.path.dirname(output_file), exist_ok=True)
        
        # ç”Ÿæˆ mihomo rule-set æ ¼å¼çš„ YAML (behavior: domain)
        print(f"\nğŸ’¾ å†™å…¥åˆ° {output_file}...")
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write("# Mihomo Fake IP Filter Rule Set\n")
            f.write("# Generated from ShellCrash and local rules\n")
            f.write("# Usage in config.yaml:\n")
            f.write("#   fake-ip-filter:\n")
            f.write("#     - 'rule-set:fake_ip_filter'\n\n")
            f.write("payload:\n")
            for rule in sorted(unique_rules):
                f.write(f"{rule}\n")
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æˆåŠŸç”Ÿæˆ
        if os.path.exists(output_file):
            file_size = os.path.getsize(output_file)
            print(f"âœ… æ–‡ä»¶ç”ŸæˆæˆåŠŸ: {output_file} ({file_size} bytes)")
        else:
            print(f"âŒ æ–‡ä»¶ç”Ÿæˆå¤±è´¥: {output_file}")
            
        print(f"\nğŸ“Š å¤„ç†å®Œæˆï¼Œå…±åŒ…å« {len(unique_rules)} æ¡ Fake IP è¿‡æ»¤è§„åˆ™")
        
        # æ˜¾ç¤ºä¸€äº›ç¤ºä¾‹è§„åˆ™ä¾›å‚è€ƒ
        print("\nğŸ“‹ ç”Ÿæˆçš„è§„åˆ™ç¤ºä¾‹ï¼ˆå‰10æ¡ï¼‰:")
        for i, rule in enumerate(sorted(unique_rules)[:10]):
            print(f"   {rule.strip()}")
        if len(unique_rules) > 10:
            print(f"   ... è¿˜æœ‰ {len(unique_rules) - 10} æ¡è§„åˆ™")
        
        EOF
        
    - name: æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶å†…å®¹
      run: |
        echo "ğŸ“„ æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
        if [ -f "rules/mihomo/fake_ip_filter.yaml" ]; then
          echo "âœ… æ–‡ä»¶å­˜åœ¨"
          echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(wc -c < rules/mihomo/fake_ip_filter.yaml) bytes"
          echo "ğŸ“Š æ–‡ä»¶è¡Œæ•°: $(wc -l < rules/mihomo/fake_ip_filter.yaml) lines"
          echo ""
          echo "ğŸ“‹ æ–‡ä»¶å†…å®¹ï¼ˆå‰20è¡Œï¼‰:"
          head -20 rules/mihomo/fake_ip_filter.yaml
          echo ""
          echo "ğŸ“‹ æ–‡ä»¶å†…å®¹ï¼ˆå10è¡Œï¼‰:"
          tail -10 rules/mihomo/fake_ip_filter.yaml
        else
          echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨!"
        fi
        
    - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: check_changes
      run: |
        echo "ğŸ” æ£€æŸ¥ Git çŠ¶æ€..."
        git status
        echo ""
        echo "ğŸ” æ£€æŸ¥æœªè·Ÿè¸ªçš„æ–‡ä»¶..."
        git ls-files --others --exclude-standard
        echo ""
        echo "ğŸ” æ£€æŸ¥å·²ä¿®æ”¹çš„æ–‡ä»¶..."
        git diff --name-only
        echo ""
        if git diff --quiet --exit-code && [ -z "$(git ls-files --others --exclude-standard)" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•å˜åŒ–"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
          echo "ğŸ” å…·ä½“å˜åŒ–:"
          git diff --stat
          git diff
        fi
        
    - name: æäº¤å˜åŒ–
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add rules/mihomo/fake_ip_filter.yaml
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° Fake IP è¿‡æ»¤è§„åˆ™
        
        - åˆå¹¶è¿œç¨‹å’Œæœ¬åœ°è§„åˆ™
        - è¿‡æ»¤æ³¨é‡Šå’Œæ— æ•ˆè¡Œ
        - ç”Ÿæˆ mihomo rule-set æ ¼å¼
        - è‡ªåŠ¨ä¸ºé€šé…ç¬¦åŸŸåæ·»åŠ å¼•å·
        
        æ›´æ–°æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        
    - name: æ¨é€å˜åŒ–
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
        
    - name: æ€»ç»“
      run: |
        echo "ğŸ‰ Action æ‰§è¡Œå®Œæˆ"
        echo "ğŸ“Š å¤„ç†ç»“æœ:"
        if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
          echo "   âœ… æ£€æµ‹åˆ°å˜åŒ–å¹¶å·²æäº¤"
        else
          echo "   â„¹ï¸  æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–ï¼Œæœªäº§ç”Ÿæäº¤"
        fi 