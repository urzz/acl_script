name: æ›´æ–° Fake IP è¿‡æ»¤è§„åˆ™

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'rules/mihomo/fake_ip_filter.list'
      - '.github/workflows/update-fake-ip-filter.yml'

jobs:
  update-fake-ip-filter:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: ä¸‹è½½å’Œå¤„ç† Fake IP è¿‡æ»¤è§„åˆ™
      run: |
        python3 << 'EOF'
        import urllib.request
        import os
        import sys
        
        def read_remote_file(url):
            """å®‰å…¨åœ°è¯»å–è¿œç¨‹æ–‡ä»¶ï¼Œå¿½ç•¥é”™è¯¯"""
            try:
                with urllib.request.urlopen(url, timeout=30) as response:
                    return response.read().decode('utf-8').splitlines()
            except Exception as e:
                print(f"è­¦å‘Š: æ— æ³•è¯»å–è¿œç¨‹æ–‡ä»¶ {url}: {e}")
                return []
        
        def read_local_file(filepath):
            """å®‰å…¨åœ°è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œå¿½ç•¥é”™è¯¯"""
            try:
                if os.path.exists(filepath):
                    with open(filepath, 'r', encoding='utf-8') as f:
                        return f.read().splitlines()
                else:
                    print(f"è­¦å‘Š: æœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨: {filepath}")
                    return []
            except Exception as e:
                print(f"è­¦å‘Š: æ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶ {filepath}: {e}")
                return []
        
        def needs_quotes(domain):
            """åˆ¤æ–­åŸŸåæ˜¯å¦éœ€è¦ç”¨å¼•å·åŒ…èµ·æ¥"""
            # åŒ…å«é€šé…ç¬¦æˆ–ç‰¹æ®Šå­—ç¬¦çš„éœ€è¦åŠ å¼•å·
            special_chars = ['*', '+', '.']
            return any(char in domain for char in special_chars) or domain.startswith('.')
        
        def filter_lines(lines):
            """è¿‡æ»¤æ‰æ³¨é‡Šè¡Œå’Œç©ºè¡Œï¼Œä¿æŒåŸå§‹åŸŸåæ ¼å¼ï¼Œé€‚å½“æ·»åŠ å¼•å·"""
            filtered = []
            for line in lines:
                line = line.strip()
                # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
                if not line or line.startswith('#'):
                    continue
                    
                # ç§»é™¤è¡Œå†…æ³¨é‡Š
                if '#' in line:
                    line = line.split('#')[0].strip()
                    if not line:
                        continue
                
                # æ ¹æ®æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦å†³å®šæ˜¯å¦åŠ å¼•å·
                if needs_quotes(line):
                    filtered.append(f"  - '{line}'")
                else:
                    filtered.append(f"  - {line}")
            
            return filtered
        
        # è¿œç¨‹æ–‡ä»¶ URL
        remote_url = "https://raw.githubusercontent.com/juewuy/ShellCrash/refs/heads/dev/public/fake_ip_filter.list"
        
        # æœ¬åœ°æ–‡ä»¶è·¯å¾„
        local_file = "rules/mihomo/fake_ip_filter.list"
        
        # è¾“å‡ºæ–‡ä»¶è·¯å¾„
        output_file = "rules/mihomo/fake_ip_filter.yaml"
        
        print("å¼€å§‹å¤„ç† Fake IP è¿‡æ»¤è§„åˆ™...")
        
        # è¯»å–è¿œç¨‹æ–‡ä»¶
        print("è¯»å–è¿œç¨‹æ–‡ä»¶...")
        remote_lines = read_remote_file(remote_url)
        print(f"è¿œç¨‹æ–‡ä»¶è¯»å–åˆ° {len(remote_lines)} è¡Œ")
        
        # è¯»å–æœ¬åœ°æ–‡ä»¶
        print("è¯»å–æœ¬åœ°æ–‡ä»¶...")
        local_lines = read_local_file(local_file)
        print(f"æœ¬åœ°æ–‡ä»¶è¯»å–åˆ° {len(local_lines)} è¡Œ")
        
        # åˆå¹¶æ‰€æœ‰è¡Œ
        all_lines = remote_lines + local_lines
        print(f"åˆå¹¶åå…± {len(all_lines)} è¡Œ")
        
        # è¿‡æ»¤å¤„ç†
        print("è¿‡æ»¤æ³¨é‡Šå’Œç©ºè¡Œ...")
        filtered_rules = filter_lines(all_lines)
        
        # å»é‡ä½†ä¿æŒåŸå§‹æ ¼å¼
        unique_rules = list(dict.fromkeys(filtered_rules))
        print(f"è¿‡æ»¤å’Œå»é‡åå…± {len(unique_rules)} æ¡è§„åˆ™")
        
        # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
        os.makedirs(os.path.dirname(output_file), exist_ok=True)
        
        # ç”Ÿæˆ mihomo rule-set æ ¼å¼çš„ YAML (behavior: domain)
        print(f"å†™å…¥åˆ° {output_file}...")
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write("# Mihomo Fake IP Filter Rule Set\n")
            f.write("# Generated from ShellCrash and local rules\n")
            f.write("# Usage in config.yaml:\n")
            f.write("#   fake-ip-filter:\n")
            f.write("#     - 'rule-set:fake_ip_filter'\n\n")
            f.write("payload:\n")
            for rule in sorted(unique_rules):
                f.write(f"{rule}\n")
        
        print(f"âœ… æˆåŠŸç”Ÿæˆ {output_file}")
        print(f"ğŸ“Š å…±åŒ…å« {len(unique_rules)} æ¡ Fake IP è¿‡æ»¤è§„åˆ™")
        
        # æ˜¾ç¤ºé…ç½®ä½¿ç”¨æ–¹æ³•
        print("\nğŸ“‹ ä½¿ç”¨æ–¹æ³•:")
        print("1. å°†ç”Ÿæˆçš„æ–‡ä»¶æ”¾ç½®åœ¨ mihomo é…ç½®ç›®å½•ä¸‹")
        print("2. åœ¨ä¸»é…ç½®æ–‡ä»¶ä¸­æ·»åŠ :")
        print("   fake-ip-filter:")
        print("     - 'rule-set:fake_ip_filter'")
        
        # æ˜¾ç¤ºä¸€äº›ç¤ºä¾‹è§„åˆ™ä¾›å‚è€ƒ
        print("\nğŸ“‹ ç”Ÿæˆçš„è§„åˆ™ç¤ºä¾‹:")
        for i, rule in enumerate(sorted(unique_rules)[:10]):
            print(f"   {rule.strip()}")
        if len(unique_rules) > 10:
            print(f"   ... è¿˜æœ‰ {len(unique_rules) - 10} æ¡è§„åˆ™")
        
        EOF
        
    - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ æ²¡æœ‰æ£€æµ‹åˆ°è§„åˆ™å˜åŒ–"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ£€æµ‹åˆ°è§„åˆ™å˜åŒ–"
          git diff --name-only
        fi
        
    - name: æäº¤å˜åŒ–
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add rules/mihomo/fake_ip_filter.yaml
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° Fake IP è¿‡æ»¤è§„åˆ™
        
        - åˆå¹¶è¿œç¨‹å’Œæœ¬åœ°è§„åˆ™
        - è¿‡æ»¤æ³¨é‡Šå’Œæ— æ•ˆè¡Œ
        - ç”Ÿæˆ mihomo rule-set æ ¼å¼
        - è‡ªåŠ¨ä¸ºé€šé…ç¬¦åŸŸåæ·»åŠ å¼•å·
        
        æ›´æ–°æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        
    - name: æ¨é€å˜åŒ–
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }} 